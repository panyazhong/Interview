## http2 多路复用

http1 中，每次请求都会建立一次 HTTP 连接，也就是我们常说的 3 次握手和 4 次握手，这个过程在一次请求过程中占用了较长的时间，即使开始 keep-alive，解决了多次连接的问题但依然存在两个效率上的问题，一是串行的文件输出，而是连接过多导致的性能问题。

http/2 的多路复用就是为了解决上述两个问题。

在 http/2 中，有两个非常重要的改名，帧（frame）和流（stream）。帧代表着最小的数据单位，每个帧会标识出该帧属于哪个流，流也就是多个帧组成的数据流。

多路复用，就在一个 TCP 连接中可以存在多条流。换句话说。也就是可以发送多个请求，对端可以通过帧中的标识知道属于哪个请求。通过这个技术，可以避免 http 旧版本中的队头阻塞问题，极大地提高传输性能。

### 三次握手 四次握手

三次握手就是指建立一个 TCP 连接是，客户端和服务端总共发送 3 个包。进行三次握手的主要作用是确认双方的接受能力和发送能力是否正常、指定自己的初始化序列号为后面的可靠性传输做准备。实质上其实就是连接服务器指定端口，建立 TCP 连接，并同步连接双方的序列号和确认号，交换<code>TCP 窗口大小</code>信息

刚开始客户端出去 Closed 状态，服务端处于 Listen 状态。

- 第一次握手：客户端给服务端发送一个 SYN 报文，并指明客户端的初始化序列号 ISN(c)。此时客户端处于<code>SYN_SEND</code>状态

  首部的同步位 SYN = 1，初始序号 seq = x, SYN = 1 的报文段不能携带数据，但消耗一个序号

- 第二次握手：服务端收到 SYN 报文之后，会以自己的 SYN 报文作为应答，并且也是指定自己的初始化序列号 ISN(s)。同时会把客户端的 ISN + 1 作为 ACK 的值，表示自己已经收到了客户端的 SYN，此时服务器处于<code>SYN_RCVD</code>

  在确认报文段中 SYN = 1，ACK = 1，确认号 ack = x + 1，初始序号 seq =y。

- 第三次握手：客户端收到 SYN 报文后，会发送一个 ACK 报文，当然，也是一样把服务端的 ISN + 1 作为 ACK 的值，表示已经接收到了服务端的 SYN 报文，只是客户端处于<code>ESTABLISHED</code>状态。服务端在收到 ACK 报文之后，也处于<code>ESTABLISHED</code>状态，双方建立连接

  确认报文 ACK = 1，确认号 ack = y + 1，序号 seq = x + 1（初始为 seq= x，第二个报文段所以要+1），ACK 报文段可以携带数据，不携带数据则不消耗序号。

发送第一个 SYN 的一端将执行主动打开（active open），接收这个 SYN 并发回下一个 SYN 的另一端执行被动打开（passive open）
